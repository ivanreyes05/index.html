<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinic Check-Up — Appointment Form</title>
  <style>
    :root {
      --bg:#f6f9fc; --card:#acb2e4; --accent:#545ff3; --muted:#071127;
      --radius:12px; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%}
    body{
      margin:0;
      background: url("photo..jpg");
      background-size: cover;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:100%; max-width:880px; background:var(--card); border-radius:var(--radius);
      box-shadow:0 6px 30px rgba(16,24,40,0.08); padding:28px; box-sizing:border-box;
    }
    h1{margin:0 0 6px; font-size:20px}
    p.lead{margin:0 0 18px; color:var(--muted); font-size:14px}
    .grid{display:grid; gap:12px; grid-template-columns:repeat(2,1fr)}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    label{display:block; font-size:13px; color:#111827; margin-bottom:6px}
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select, textarea {
      width:100%; padding:10px 12px; border:1px solid #e6e9ee; border-radius:8px; box-sizing:border-box;
      font-size:14px; outline:none;
    }
    input:focus, select:focus, textarea:focus { box-shadow:0 0 0 4px rgba(37,99,235,0.08); border-color:var(--accent) }
    .row{display:flex; gap:10px}
    .btn{
      background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:10px; font-weight:600;
      cursor:pointer;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .helper{font-size:13px; color:var(--muted); margin-top:6px}
    .notice{margin-top:12px; padding:12px; background:#ecfeff; border:1px solid #bff0f7; border-radius:8px; color:#065f46}
    .actions{display:flex; gap:10px; align-items:center; margin-top:16px; justify-content:flex-end; flex-wrap:wrap}
    .fullwidth{grid-column:1/-1}
    .required::after{content:" *"; color:#dc2626}
    .success{background:#ecfdf5; border:1px solid #bbf7d0; padding:12px; border-radius:8px; color:#065f46}
    .error{background:#fff1f2; border:1px solid #fecaca; padding:12px; border-radius:8px; color:#991b1b}
  </style>
</head>

<!-- Firebase SDKs (Compat version only) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Excel Export Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<body>
  <main class="card" role="main">
    <header>
      <h1>loveCare Clinic Appointment For Check-up</h1>
      <p class="lead">Complete this form to request a clinic check-up appointment. We'll contact you to confirm the schedule.</p>
    </header>

    <form id="appointmentForm" novalidate>
      <section class="grid" aria-labelledby="patient-details">
        <div>
          <label for="fullName" class="required">Full name</label>
          <input id="fullName" name="fullName" type="text" autocomplete="name" required minlength="2" />
          <div class="helper">As shown on your ID</div>
        </div>

        <div>
          <label for="email" class="required">Email</label>
          <input id="email" name="email" type="email" autocomplete="email" required />
        </div>

        <div>
          <label for="phone" class="required">Phone number</label>
          <input id="phone" name="phone" type="tel" inputmode="tel" autocomplete="tel" required pattern="^[0-9+()\-\s]{7,25}$" />
        </div>

        <div>
          <label for="dob">Date of birth</label>
          <input id="dob" name="dob" type="date" max="" />
        </div>

        <div>
          <label for="service" class="required">Service type</label>
          <select id="service" name="service" required>
            <option value="">-- select service --</option>
            <option>General Check-Up</option>
            <option>Blood Test</option>
            <option>Physical Exam</option>
            <option>Consultation</option>
            <option>Vaccination</option>
          </select>
        </div>

        <div>
          <label for="doctor">Preferred doctor (optional)</label>
          <input id="doctor" name="doctor" type="text" placeholder>
        </div>

        <div>
          <label for="preferredDate" class="required">Preferred appointment date</label>
          <input id="preferredDate" name="preferredDate" type="date" required />
        </div>

        <div>
          <label for="preferredTime">Preferred time</label>
          <select id="preferredTime" name="preferredTime">
            <option value="">Anytime</option>
            <option>08:00am - 09:30am</option>
            <option>10:00am - 11:30am</option>
            <option>2:00pm - 2:30pm</option>
            <option>3:00pm - 4:30pm</option>
          </select>
        </div>

        <div class="fullwidth">
          <label for="symptoms">Reason for visit / Symptoms</label>
          <textarea id="symptoms" name="symptoms" rows="4" placeholder></textarea>
        </div>

        <div>
          <label for="insurance">Insurance provider (optional)</label>
          <input id="insurance" name="insurance" type="text" placeholder>
        </div>

        <div>
          <label for="consent" class="required">Consent</label>
          <div class="row">
            <input id="consent" name="consent" type="checkbox" required />
            <label for="consent" style="margin:0">I agree to be contacted for appointment confirmation and consent to the clinic's privacy policy.</label>
          </div>
        </div>

        <div class="fullwidth">
          <div id="formMessage" aria-live="polite"></div>
          <div class="actions">
            <button type="button" id="resetBtn">Reset</button>
            <button type="submit" id="submitBtn" class="btn">Request Appointment</button>
          </div>
        </div>
      </section>
    </form>

    <div class="notice">
      If this is an emergency, please call <strong>999 / your local emergency number</strong> or go to the nearest hospital.
    </div>
  </main>

  <script>
    // ✅ Firebase Config (replace with your own project settings)
    const firebaseConfig = {
      apiKey: "AIzaSyBb5rVhifgyW1xH73SKlE1OdRA_mxoomJY",
      authDomain: "project-for-it-ae279.firebaseapp.com",
      projectId: "project-for-it-ae279",
      storageBucket: "project-for-it-ae279.appspot.com",
      messagingSenderId: "72118598004",
      appId: "1:72118598004:web:f086be80fe92745f58d421"
    };

    // Init Firebase + Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Set max DOB to today
    document.getElementById('dob').max = new Date().toISOString().split('T')[0];

    const form = document.getElementById('appointmentForm');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const messageEl = document.getElementById('formMessage');

    function showMessage(type, text) {
      messageEl.innerHTML = `<div class="${type === 'success' ? 'success' : 'error'}">${text}</div>`;
    }

    // ✅ Save Appointment to Firestore + Auto Export Excel
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageEl.innerHTML = '';

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const data = {
        fullName: form.fullName.value.trim(),
        email: form.email.value.trim(),
        phone: form.phone.value.trim(),
        dob: form.dob.value || null,
        service: form.service.value,
        doctor: form.doctor.value.trim() || null,
        preferredDate: form.preferredDate.value,
        preferredTime: form.preferredTime.value || null,
        symptoms: form.symptoms.value.trim() || null,
        insurance: form.insurance.value.trim() || null,
        consent: form.consent.checked,
        createdAt: new Date().toISOString()
      };

      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      try {
        // Save to Firestore
        await db.collection("appointments").add(data);

        // Fetch all appointments → Excel
        const snapshot = await db.collection("appointments").get();
        const records = snapshot.docs.map(doc => doc.data());

        if (records.length > 0) {
          const ws = XLSX.utils.json_to_sheet(records);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Appointments");
          XLSX.writeFile(wb, "appointments.xlsx");
        }

        showMessage('success', '✅ Appointment saved!');
        form.reset();
      } catch (error) {
        console.error('Firestore error', error);
        showMessage('error', '❌ Unable to save appointment. ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Request Appointment';
      }
    });

    // Reset form
    resetBtn.addEventListener('click', () => {
      form.reset();
      messageEl.innerHTML = '';
    });
  </script>
</body>
</html>